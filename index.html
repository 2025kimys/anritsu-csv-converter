<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>안리츠 장비 CSV 변환기</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      line-height: 1.5;
    }
    h1 {
      margin-bottom: 0.2rem;
    }
    .section {
      margin-top: 1.5rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .section h2 {
      margin-top: 0;
    }
    .btn {
      display: inline-block;
      padding: 0.4rem 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }
    .btn-primary {
      background-color: #1f77b4;
      color: white;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    #map {
      height: 420px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .small {
      font-size: 0.85rem;
    }
    .muted {
      color: #777;
      font-size: 0.85rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    thead {
      background-color: #f5f5f5;
    }
    .expander {
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 0.5rem;
    }
    .expander-header {
      background: #f7f7f7;
      padding: 0.4rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }
    .expander-body {
      display: none;
      padding: 0.6rem;
    }
    .badge {
      background: #e7e7e7;
      padding: 0.1rem 0.35rem;
      border-radius: 4px;
      font-size: 0.7rem;
    }
  </style>
</head>

<body>

  <h1>안리츠 장비 CSV 변환기</h1>
  <div class="small muted">
    여러 CSV 파일을 업로드하여 총 채널 파워(dBm)를 계산하고 지도/CSV로 시각화합니다.
    (모든 처리는 브라우저 내부에서만 실행됨)
  </div>

  <!-- 1. 파일 업로드 -->
  <div class="section">
    <h2>1. CSV 파일 업로드</h2>
    <input id="fileInput" type="file" accept=".csv" multiple />
    <div id="fileInfo" class="small"></div>
    <ul id="fileList" class="small"></ul>

    <button id="convertButton" class="btn btn-primary" disabled>
      모든 파일 변환 실행
    </button>
    <div id="convertStatus" class="small"></div>
  </div>

  <!-- 2. 개별 결과 -->
  <div class="section">
    <h2>2. 파일별 변환 결과</h2>
    <div id="perFileResults" class="muted">아직 변환 결과 없음</div>
  </div>

  <!-- 3. 통합 결과 -->
  <div class="section">
    <h2>3. 모든 파일 통합 결과</h2>
    <div id="mergedResult" class="muted">아직 데이터 없음</div>

    <!-- 지도 영역 -->
    <div id="mapSection" style="display:none; margin-top:1rem;">
      <div class="small"><b>GPS 기반 이동 경로 지도</b></div>
      <div id="map"></div>
    </div>
  </div>

<script>
/* -------------------------
   파이썬 로직 → JS 변환
--------------------------*/

function computeTotalChDbm(vals) {
  const mw = vals
    .filter(v => v !== null && !isNaN(v))
    .map(v => Math.pow(10, v / 10));
  if (!mw.length) return NaN;
  const sum = mw.reduce((a,b)=>a+b,0);
  return 10 * Math.log10(sum);
}

function parseFileMakeSummary(csvText, fname) {
  let lines = csvText.split(/\r?\n/).map(s => s.trim()).filter(s => s.length > 0);
  if (lines.length <= 19) return [];
  const dataLines = lines.slice(19);
  const tokens = dataLines.map(r => r.split(","));
  if (!tokens.length) return [];

  const freq = {};
  tokens.forEach(t => freq[t.length] = (freq[t.length] || 0) + 1);
  const mode = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0];
  const wide = tokens.filter(t => t.length == mode);
  if (wide.length < 3) return [];

  const out = [];

  for (let i=2; i < wide.length; i++) {
    const wr = wide[i];
    const idx = parseInt(wr[0]);
    if (isNaN(idx)) continue;

    const dt = wr[1] || "";
    const lon = parseFloat(wr[2]);
    const lat = parseFloat(wr[3]);

    const values = wr.slice(5, wr.length - 1).map(x => {
      const v = parseFloat(x);
      return isNaN(v) ? NaN : v;
    });

    const total = computeTotalChDbm(values);

    out.push({
      DateTime: dt,
      Longitude: lon,
      Latitude: lat,
      Total_CH_power_dBm: total,
      __source_file__: fname
    });
  }
  return out;
}

function rowsToCsv(rows) {
  if (!rows.length) return "";
  const header = ["DateTime","Longitude","Latitude","Total_CH_power_dBm","__source_file__"];
  const lines = [header.join(",")];
  rows.forEach(r => {
    const line = header.map(h => r[h] ?? "").join(",");
    lines.push(line);
  });
  return lines.join("\r\n");
}

function renderTable(div, rows, n=10) {
  if (!rows.length) return div.textContent = "표시할 데이터 없음";

  const header = ["DateTime","Longitude","Latitude","Total_CH_power_dBm","__source_file__"];
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");

  header.forEach(h=>{
    const th = document.createElement("th");
    th.textContent = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  for (let i=0; i < Math.min(n, rows.length); i++) {
    const r = rows[i];
    const tr = document.createElement("tr");
    header.forEach(h=>{
      const td = document.createElement("td");
      td.textContent = r[h] ?? "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  div.innerHTML = "";
  div.appendChild(table);
}

/* -------------------------
   Leaflet 지도 렌더링
--------------------------*/

let map = null;
let mapLayer = null;

function renderMapFromRows(rows) {
  const valid = rows.filter(r =>
    typeof r.Latitude === "number" &&
    typeof r.Longitude === "number" &&
    !isNaN(r.Latitude) &&
    !isNaN(r.Longitude)
  );
  if (!valid.length) {
    document.getElementById("mapSection").style.display = "none";
    return;
  }

  document.getElementById("mapSection").style.display = "block";

  const avgLat = valid.reduce((a,b)=>a+b.Latitude,0) / valid.length;
  const avgLon = valid.reduce((a,b)=>a+b.Longitude,0) / valid.length;

  if (!map) {
    map = L.map("map").setView([avgLat, avgLon], 15);

    /* ✔ CARTO POSITRON 스타일 — 이미지와 가장 유사 */
    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
      }
    ).addTo(map);

    mapLayer = L.layerGroup().addTo(map);
  } else {
    map.setView([avgLat, avgLon], 15);
    mapLayer.clearLayers();
  }

  const latlngs = [];

  valid.forEach(p => {
    const latlng = [p.Latitude, p.Longitude];
    latlngs.push(latlng);

    L.circleMarker(latlng, {
      radius: 4,
      color: "orange",
      fillColor: "orange",
      fillOpacity: 0.6,
      weight: 1
    }).addTo(mapLayer);
  });

  if (latlngs.length > 1) {
    const bounds = L.latLngBounds(latlngs);
    map.fitBounds(bounds.pad(0.1));
  }
}

/* -------------------------
   파일 업로드 및 변환
--------------------------*/

let selectedFiles = [];

const fileInput = document.getElementById("fileInput");
const fileInfo = document.getElementById("fileInfo");
const fileList = document.getElementById("fileList");

fileInput.addEventListener("change", () => {
  selectedFiles = Array.from(fileInput.files || []);
  fileList.innerHTML = "";
  if (!selectedFiles.length) {
    fileInfo.textContent = "선택된 파일이 없습니다.";
    document.getElementById("convertButton").disabled = true;
    return;
  }

  fileInfo.textContent = `${selectedFiles.length}개 파일 선택됨`;
  selectedFiles.forEach(f=>{
    const li = document.createElement("li");
    li.textContent = `${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
    fileList.appendChild(li);
  });

  document.getElementById("convertButton").disabled = false;
});

document.getElementById("convertButton").addEventListener("click", async () => {

  document.getElementById("convertStatus").textContent = "변환 중...";
  const perFileResults = document.getElementById("perFileResults");
  const mergedResult = document.getElementById("mergedResult");

  perFileResults.innerHTML = "";
  mergedResult.innerHTML = "";

  const allRows = [];

  for (const file of selectedFiles) {
    const text = await file.text();
    const rows = parseFileMakeSummary(text, file.name);
    allRows.push(...rows);

    const expander = document.createElement("div");
    expander.className = "expander";

    const header = document.createElement("div");
    header.className = "expander-header";
    header.innerHTML = `${file.name}`;
    header.onclick = () => {
      body.style.display = (body.style.display === "block" ? "none" : "block");
    };

    const body = document.createElement("div");
    body.className = "expander-body";

    const tableDiv = document.createElement("div");
    renderTable(tableDiv, rows, 10);
    body.appendChild(tableDiv);

    const btn = document.createElement("button");
    btn.className = "btn btn-secondary";
    btn.textContent = "이 파일만 CSV 다운로드";
    btn.onclick = () => {
      const csv = rowsToCsv(rows);
      const name = file.name.replace(/\.csv$/i, "") + "_edit.csv";
      downloadCsv(name, csv);
    };

    body.appendChild(btn);

    expander.appendChild(header);
    expander.appendChild(body);
    perFileResults.appendChild(expander);
  }

  if (!allRows.length) {
    mergedResult.textContent = "통합 결과 없음";
    return;
  }

  const d = document.createElement("div");
  d.innerHTML = `<b>통합 행 수: ${allRows.length}</b>`;
  mergedResult.appendChild(d);

  const tableDiv = document.createElement("div");
  renderTable(tableDiv, allRows, 10);
  mergedResult.appendChild(tableDiv);

  const allBtn = document.createElement("button");
  allBtn.className = "btn btn-primary";
  allBtn.textContent = "통합 CSV 다운로드";
  allBtn.onclick = () => {
    downloadCsv("all_converted_merged.csv", rowsToCsv(allRows));
  };
  mergedResult.appendChild(allBtn);

  renderMapFromRows(allRows);

  document.getElementById("convertStatus").textContent = "완료";
});

function downloadCsv(filename, content) {
  const blob = new Blob([content], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

</script>

</body>
</html>
