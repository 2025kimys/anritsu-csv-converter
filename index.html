<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>안리츠 장비 CSV 변환기</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      line-height: 1.5;
    }
    h1 {
      margin-bottom: 0.2rem;
    }
    .section {
      margin-top: 1.5rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .section h2 {
      margin-top: 0;
    }
    .btn {
      display: inline-block;
      padding: 0.4rem 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }
    .btn-primary {
      background-color: #1f77b4;
      color: white;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .small {
      font-size: 0.85rem;
    }
    .muted {
      color: #777;
      font-size: 0.85rem;
    }
    #fileList {
      margin-top: 0.3rem;
      padding-left: 1.2rem;
    }
    #fileList li {
      font-size: 0.85rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 220px;
    }
    thead {
      background-color: #f5f5f5;
    }
    .expander {
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 0.5rem;
    }
    .expander-header {
      background: #f7f7f7;
      padding: 0.4rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .expander-body {
      display: none;
      padding: 0.6rem;
    }
    .badge {
      background: #e7e7e7;
      padding: 0.1rem 0.35rem;
      border-radius: 4px;
      font-size: 0.7rem;
    }
    #map {
      height: 420px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>

<body>

  <h1>안리츠 장비 CSV 변환기</h1>
  <div class="small muted">
    여러 CSV 측정 파일을 업로드하면 총 채널 파워(dBm)를 계산하고,<br/>
    파일별/통합 CSV와 GPS 기반 지도 결과를 브라우저에서 바로 확인할 수 있습니다.
    (모든 처리는 로컬 브라우저에서만 수행됨)
  </div>

  <!-- 1. CSV 업로드 -->
  <div class="section">
    <h2>1. CSV 파일 업로드</h2>
    <input id="fileInput" type="file" accept=".csv" multiple />
    <div id="fileInfo" class="small" style="margin-top:0.3rem;"></div>
    <ul id="fileList"></ul>

    <button id="convertButton" class="btn btn-primary" disabled>
      모든 파일 변환 실행
    </button>
    <span id="convertStatus" class="small" style="margin-left:0.5rem;"></span>
  </div>

  <!-- 2. 파일별 결과 -->
  <div class="section">
    <h2>2. 파일별 변환 결과</h2>
    <div id="perFileResults" class="muted">아직 변환 결과가 없습니다.</div>
  </div>

  <!-- 3. 통합 결과 + 지도 -->
  <div class="section">
    <h2>3. 모든 파일 통합 결과</h2>
    <div id="mergedResult" class="muted">아직 통합 결과가 없습니다.</div>

    <div id="mapSection" style="display:none; margin-top:1rem;">
      <div class="small"><b>GPS 기반 이동 경로 지도</b></div>
      <div id="map"></div>
      <div class="small muted" style="margin-top:0.3rem;">
        색상: 약한 신호(초록) → 강한 신호(빨강). 점을 클릭하면 dBm / 시간 / 파일명을 볼 수 있습니다.
      </div>
    </div>
  </div>

<script>
/* -------------------------
   1. 파이썬 로직 → JS 포팅
--------------------------*/

// dBm 리스트 -> 선형(mW) 합산 -> dBm
function computeTotalChDbm(dbmValues) {
  const lin = dbmValues
    .filter(v => v !== null && !Number.isNaN(v))
    .map(v => Math.pow(10, v / 10));

  if (!lin.length) return NaN;
  const sum = lin.reduce((a, b) => a + b, 0);
  if (sum <= 0) return NaN;
  return 10 * Math.log10(sum);
}

// CSV 텍스트 + 파일명 -> 요약 행 배열
function parseFileMakeSummary(csvText, filename) {
  let lines = csvText.split(/\r?\n/).map(s => s.replace(/\r/g, "")).filter(s => s.trim().length > 0);
  if (lines.length <= 19) return [];

  // 헤더 19줄 스킵 (필요시 조정 가능)
  const dataLines = lines.slice(19);
  const tokens = dataLines.map(r => r.split(","));
  if (!tokens.length) return [];

  // 컬럼 수 최빈값
  const lengthCount = {};
  tokens.forEach(t => {
    const n = t.length;
    lengthCount[n] = (lengthCount[n] || 0) + 1;
  });
  const modeEntry = Object.entries(lengthCount).sort((a,b)=>b[1]-a[1])[0];
  if (!modeEntry) return [];
  const ncolsMode = parseInt(modeEntry[0], 10);
  const wideRows = tokens.filter(t => t.length === ncolsMode);
  if (wideRows.length < 3) return [];

  const out = [];

  // 상위 2행은 헤더, 그 이후부터 데이터
  for (let i = 2; i < wideRows.length; i++) {
    const wr = wideRows[i];

    const idx = parseInt(wr[0], 10);
    if (Number.isNaN(idx)) continue;

    const dt = wr[1] || "";
    const lon = wr[2] ? parseFloat(wr[2]) : NaN;
    const lat = wr[3] ? parseFloat(wr[3]) : NaN;

    const valsTokens = wr.length > 6 ? wr.slice(5, wr.length - 1) : [];
    const vals = valsTokens.map(x => {
      if (x.trim() === "") return NaN;
      const v = parseFloat(x);
      return Number.isNaN(v) ? NaN : v;
    });

    const totalDbm = valsTokens.length ? computeTotalChDbm(vals) : NaN;

    out.push({
      DateTime: dt,
      Longitude: lon,
      Latitude: lat,
      Total_CH_power_dBm: totalDbm,
      __source_file__: filename
    });
  }
  return out;
}

// 행 배열 -> CSV 문자열
function rowsToCsv(rows) {
  if (!rows.length) return "";
  const headers = ["DateTime", "Longitude", "Latitude", "Total_CH_power_dBm", "__source_file__"];
  const lines = [headers.join(",")];
  rows.forEach(r => {
    const vals = headers.map(h => {
      const v = r[h];
      if (v === null || v === undefined || Number.isNaN(v)) return "";
      return String(v);
    });
    lines.push(vals.join(","));
  });
  return lines.join("\r\n");
}

// 테이블 렌더링 (상위 n행만)
function renderTable(container, rows, maxRows = 10) {
  container.innerHTML = "";
  if (!rows.length) {
    container.textContent = "표시할 데이터가 없습니다.";
    return;
  }
  const headers = ["DateTime", "Longitude", "Latitude", "Total_CH_power_dBm", "__source_file__"];
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const n = Math.min(maxRows, rows.length);
  for (let i = 0; i < n; i++) {
    const r = rows[i];
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      const v = r[h];
      td.textContent = (v === null || v === undefined || Number.isNaN(v)) ? "" : String(v);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  container.appendChild(table);
}

/* -------------------------
   2. dBm → 색상 매핑 함수
--------------------------*/

// 약한 신호(낮은 dBm) -> 초록, 강한 신호(높은 dBm) -> 빨강
function getColorFromDbm(dbm) {
  if (dbm === null || dbm === undefined || Number.isNaN(dbm)) {
    return "#888888";
  }
  const min = -55;  // 최소 dBm (필요시 조정)
  const max = 0;   // 최대 dBm
  const clamped = Math.max(min, Math.min(max, dbm));
  const ratio = (clamped - min) / (max - min); // 0 ~ 1

  // ratio 0 → 초록(0,255,0), 1 → 빨강(255,0,0)
  const r = Math.floor(255 * ratio);
  const g = Math.floor(255 * (1 - ratio));
  const b = 0;
  return `rgb(${r}, ${g}, ${b})`;
}

/* -------------------------
   3. Leaflet 지도 렌더링
--------------------------*/

let map = null;
let mapLayerGroup = null;

function renderMapFromRows(rows) {
  const mapSection = document.getElementById("mapSection");

  const points = rows.filter(r =>
    typeof r.Latitude === "number" &&
    typeof r.Longitude === "number" &&
    !Number.isNaN(r.Latitude) &&
    !Number.isNaN(r.Longitude)
  );

  if (!points.length) {
    mapSection.style.display = "none";
    return;
  }

  mapSection.style.display = "block";

  const avgLat = points.reduce((sum, r) => sum + r.Latitude, 0) / points.length;
  const avgLon = points.reduce((sum, r) => sum + r.Longitude, 0) / points.length;

  if (!map) {
    map = L.map("map").setView([avgLat, avgLon], 15);

    // Carto Positron (light_all) - 심플한 회색 베이스맵
    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
      }
    ).addTo(map);

    mapLayerGroup = L.layerGroup().addTo(map);
  } else {
    map.setView([avgLat, avgLon], 15);
    mapLayerGroup.clearLayers();
  }

  const latlngs = [];

  points.forEach(p => {
    const latlng = [p.Latitude, p.Longitude];
    latlngs.push(latlng);

    const color = getColorFromDbm(p.Total_CH_power_dBm);

    L.circleMarker(latlng, {
      radius: 5,
      color: color,
      fillColor: color,
      fillOpacity: 0.7,
      weight: 1
    })
    .bindPopup(
      `<b>Total_CH_power_dBm:</b> ${
        (p.Total_CH_power_dBm !== null && !Number.isNaN(p.Total_CH_power_dBm))
          ? p.Total_CH_power_dBm.toFixed(2)
          : "N/A"
      } dBm<br/>
       <b>DateTime:</b> ${p.DateTime || ""}<br/>
       <b>File:</b> ${p.__source_file__ || ""}`
    )
    .addTo(mapLayerGroup);
  });

  if (latlngs.length > 1) {
    const bounds = L.latLngBounds(latlngs);
    map.fitBounds(bounds.pad(0.1));
  }
}

/* -------------------------
   4. CSV 업로드/변환 로직
--------------------------*/

let selectedFiles = [];

const fileInput = document.getElementById("fileInput");
const fileInfo = document.getElementById("fileInfo");
const fileList = document.getElementById("fileList");
const convertButton = document.getElementById("convertButton");
const convertStatus = document.getElementById("convertStatus");
const perFileResults = document.getElementById("perFileResults");
const mergedResult = document.getElementById("mergedResult");

fileInput.addEventListener("change", () => {
  selectedFiles = Array.from(fileInput.files || []);
  fileList.innerHTML = "";
  convertStatus.textContent = "";
  perFileResults.textContent = "아직 변환 결과가 없습니다.";
  mergedResult.textContent = "아직 통합 결과가 없습니다.";
  document.getElementById("mapSection").style.display = "none";

  if (!selectedFiles.length) {
    fileInfo.textContent = "선택된 파일이 없습니다.";
    convertButton.disabled = true;
    return;
  }

  fileInfo.textContent = `${selectedFiles.length}개 파일 선택됨`;
  selectedFiles.forEach(f => {
    const li = document.createElement("li");
    li.textContent = `${f.name} (${(f.size / (1024 * 1024)).toFixed(2)} MB)`;
    fileList.appendChild(li);
  });

  convertButton.disabled = false;
});

convertButton.addEventListener("click", async () => {
  if (!selectedFiles.length) return;

  convertButton.disabled = true;
  convertStatus.textContent = "변환 중...";

  perFileResults.innerHTML = "";
  mergedResult.innerHTML = "";

  const allRows = [];

  for (const file of selectedFiles) {
    try {
      const text = await file.text();
      const rows = parseFileMakeSummary(text, file.name);
      allRows.push(...rows);

      // 파일별 결과 UI (expander)
      const expander = document.createElement("div");
      expander.className = "expander";

      const header = document.createElement("div");
      header.className = "expander-header";
      header.innerHTML = `<span>${file.name}</span><span class="badge">행 수: ${rows.length}</span>`;
      expander.appendChild(header);

      const body = document.createElement("div");
      body.className = "expander-body";

      const tableDiv = document.createElement("div");
      renderTable(tableDiv, rows, 10);
      body.appendChild(tableDiv);

      const btn = document.createElement("button");
      btn.className = "btn btn-secondary";
      btn.textContent = "이 파일만 CSV 다운로드";
      btn.style.marginTop = "0.5rem";
      btn.addEventListener("click", () => {
        const csv = rowsToCsv(rows);
        const baseName = file.name.replace(/\.csv$/i, "");
        downloadCsv(`${baseName}_edit.csv`, csv);
      });
      body.appendChild(btn);

      header.addEventListener("click", () => {
        body.style.display = (body.style.display === "block" ? "none" : "block");
      });

      expander.appendChild(body);
      perFileResults.appendChild(expander);

    } catch (e) {
      const p = document.createElement("p");
      p.className = "small";
      p.style.color = "red";
      p.textContent = `${file.name} 변환 중 오류: ${e}`;
      perFileResults.appendChild(p);
    }
  }

  if (!allRows.length) {
    mergedResult.textContent = "통합 결과가 없습니다. CSV 포맷을 확인하세요.";
    document.getElementById("mapSection").style.display = "none";
  } else {
    mergedResult.innerHTML = "";
    const summary = document.createElement("div");
    summary.innerHTML = `<b>모든 파일 변환 완료! 통합 행 수: ${allRows.length}</b>`;
    mergedResult.appendChild(summary);

    const tableDiv = document.createElement("div");
    renderTable(tableDiv, allRows, 10);
    mergedResult.appendChild(tableDiv);

    const btnAll = document.createElement("button");
    btnAll.className = "btn btn-primary";
    btnAll.textContent = "통합 CSV 다운로드";
    btnAll.style.marginTop = "0.5rem";
    btnAll.addEventListener("click", () => {
      const csv = rowsToCsv(allRows);
      downloadCsv("all_converted_merged.csv", csv);
    });
    mergedResult.appendChild(btnAll);

    // 지도 갱신
    renderMapFromRows(allRows);
  }

  convertStatus.textContent = "완료";
  convertButton.disabled = false;
});

function downloadCsv(filename, content) {
  const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

</script>

</body>
</html>


